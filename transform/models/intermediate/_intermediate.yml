version: 2

models:
  - name: int_ip_addresses
    description: Unique IP addresses from events. {{ doc('surrogate_key_methodology') }}
    columns:
      - name: ip_address_id
        description: "{{ doc('ip_address_id') }}"
        tests:
          - unique
          - not_null
      - name: ip_address
        description: "{{ doc('ip_address') }}"
        tests:
          - unique
          - not_null

  - name: int_users
    description: User dimension with latest device and IP per amplitude_id. Uses ROW_NUMBER to keep most recent record.
    columns:
      - name: amplitude_id
        description: "{{ doc('amplitude_id') }} Primary key for this table."
        tests:
          - unique
          - not_null
      - name: user_id
        description: "{{ doc('user_id') }}"
      - name: device_id
        description: "{{ doc('device_id') }}"
      - name: ip_address_id
        description: "{{ doc('ip_address_id') }}"
        tests:
          - relationships:
              to: ref('int_ip_addresses')
              field: ip_address_id
      - name: company
        description: "{{ doc('company') }} NULL until enriched by int_companies model."
      - name: last_seen
        description: "{{ doc('last_seen') }}"

  - name: int_sessions
    description: |
      Sessionized events with aggregated metrics and user journey paths.
      {{ doc('incremental_strategy') }}
    columns:
      - name: session_id
        description: "{{ doc('session_id') }}"
        tests:
          - unique
          - not_null
      - name: session_id_raw
        description: "{{ doc('session_id_raw') }}"
        tests:
          - not_null
      - name: amplitude_id
        description: "{{ doc('amplitude_id') }}"
        tests:
          - not_null
          - relationships:
              to: ref('int_users')
              field: amplitude_id
      - name: user_id
        description: "{{ doc('user_id') }}"
      - name: device_id
        description: "{{ doc('device_id') }}"
      - name: session_start
        description: "{{ doc('session_start') }}"
        tests:
          - not_null
      - name: session_end
        description: "{{ doc('session_end') }}"
        tests:
          - not_null
      - name: event_count
        description: "{{ doc('event_count') }}"
      - name: user_journey
        description: "{{ doc('user_journey') }}"
      - name: location_id
        description: "{{ doc('location_id') }}"

  - name: int_event_properties
    description: Unique event property combinations extracted from JSON. {{ doc('surrogate_key_methodology') }}
    columns:
      - name: event_properties_id
        description: "{{ doc('event_properties_id') }}"
        tests:
          - unique
          - not_null
      - name: properties_json
        description: "{{ doc('properties_json') }}"
      - name: url
        description: "{{ doc('url') }}"
      - name: referrer
        description: "{{ doc('referrer') }}"
      - name: referring_domain
        description: "{{ doc('referring_domain') }}"
      - name: element_text
        description: "{{ doc('element_text') }}"
      - name: page_title
        description: "{{ doc('page_title') }}"

  - name: int_events
    description: |
      Deduplicated event fact table with foreign keys to all dimensions.
      {{ doc('deduplication_note') }}
      {{ doc('incremental_strategy') }}
    columns:
      - name: event_id
        description: "{{ doc('event_id') }}"
        tests:
          - unique
          - not_null
      - name: event_id_raw
        description: "{{ doc('event_id_raw') }}"
      - name: session_id
        description: "{{ doc('session_id') }}"
        tests:
          - relationships:
              to: ref('int_sessions')
              field: session_id
      - name: session_id_raw
        description: "{{ doc('session_id_raw') }}"
      - name: amplitude_id
        description: "{{ doc('amplitude_id') }}"
        tests:
          - not_null
          - relationships:
              to: ref('int_users')
              field: amplitude_id
      - name: ip_address_id
        description: "{{ doc('ip_address_id') }}"
        tests:
          - relationships:
              to: ref('int_ip_addresses')
              field: ip_address_id
      - name: event_time
        description: "{{ doc('event_time') }}"
        tests:
          - not_null
      - name: event_type
        description: "{{ doc('event_type') }}"
        tests:
          - not_null
      - name: user_properties_id
        description: "{{ doc('user_properties_id') }}"
      - name: event_properties_id
        description: "{{ doc('event_properties_id') }}"
        tests:
          - relationships:
              to: ref('int_event_properties')
              field: event_properties_id
      - name: company_name
        description: "{{ doc('company_name') }}"
      - name: uuid
        description: "{{ doc('uuid') }}"
        tests:
          - unique
          - not_null

  - name: int_companies
    description: |
      Companies extracted from email domains, unique per (company, IP address).
      Consumer email providers (gmail.com, yahoo.com, etc.) are filtered out.
      {{ doc('surrogate_key_methodology') }}
    columns:
      - name: company_id
        description: "{{ doc('company_id') }}"
        tests:
          - unique
          - not_null
      - name: company
        description: "{{ doc('company') }}"
        tests:
          - not_null
      - name: ip_address
        description: "{{ doc('ip_address') }}"
        tests:
          - not_null