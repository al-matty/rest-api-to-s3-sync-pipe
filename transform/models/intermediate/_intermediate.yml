version: 2

models:
  - name: int_ip_addresses
    description: Unique IP addresses from events
    columns:
      - name: ip_address_id
        description: Surrogate key generated from IP address
        tests:
          - unique
          - not_null
      - name: ip_address
        description: IP address (IPv4 or IPv6)
        tests:
          - unique
          - not_null

  - name: int_users
    description: User dimension with latest device and IP per amplitude_id
    columns:
      - name: amplitude_id
        description: Amplitude's internal user identifier (primary key)
        tests:
          - unique
          - not_null
      - name: user_id
        description: User identifier (often email address)
      - name: device_id
        description: Device identifier
      - name: ip_address_id
        description: Foreign key to IP addresses
        tests:
          - relationships:
              to: ref('int_ip_addresses')
              field: ip_address_id
      - name: company
        description: Company name enriched from email domain (NULL until int_companies runs)
      - name: last_seen
        description: Timestamp of most recent event for this user

  - name: int_sessions
    description: Sessionized events with aggregated metrics and user journey paths
    columns:
      - name: session_id
        description: Surrogate key from session_id_raw + amplitude_id
        tests:
          - unique
          - not_null
      - name: session_id_raw
        description: Raw session ID from Amplitude
        tests:
          - not_null
      - name: amplitude_id
        description: Amplitude user identifier
        tests:
          - not_null
          - relationships:
              to: ref('int_users')
              field: amplitude_id
      - name: user_id
        description: User identifier from session
      - name: device_id
        description: Device identifier from session
      - name: session_start
        description: Timestamp of first event in session
        tests:
          - not_null
      - name: session_end
        description: Timestamp of last event in session
        tests:
          - not_null
      - name: event_count
        description: Number of events in this session
      - name: user_journey
        description: Concatenated page paths showing user navigation flow
      - name: location_id
        description: Surrogate key from city, region, country

  - name: int_event_properties
    description: Unique event property combinations extracted from JSON
    columns:
      - name: event_properties_id
        description: Surrogate key from full event properties JSON
        tests:
          - unique
          - not_null
      - name: properties_json
        description: Full event properties as VARIANT/JSON
      - name: url
        description: Page URL (extracted from Amplitude Page URL property)
      - name: referrer
        description: Referrer URL
      - name: referring_domain
        description: Referring domain
      - name: element_text
        description: Text of clicked element
      - name: page_title
        description: Page title

  - name: int_events
    description: Deduplicated event fact table with foreign keys to all dimensions
    columns:
      - name: event_id
        description: Surrogate key from UUID
        tests:
          - unique
          - not_null
      - name: event_id_raw
        description: Raw event ID from Amplitude
      - name: session_id
        description: Foreign key to sessions
        tests:
          - relationships:
              to: ref('int_sessions')
              field: session_id
      - name: session_id_raw
        description: Raw session ID
      - name: amplitude_id
        description: Foreign key to users
        tests:
          - not_null
          - relationships:
              to: ref('int_users')
              field: amplitude_id
      - name: ip_address_id
        description: Foreign key to IP addresses
        tests:
          - relationships:
              to: ref('int_ip_addresses')
              field: ip_address_id
      - name: event_time
        description: Timestamp when event occurred
        tests:
          - not_null
      - name: event_type
        description: Type of event (e.g., page_view, session_start)
        tests:
          - not_null
      - name: user_properties_id
        description: Surrogate key from user properties JSON
      - name: event_properties_id
        description: Foreign key to event properties
        tests:
          - relationships:
              to: ref('int_event_properties')
              field: event_properties_id
      - name: company_name
        description: Denormalized company name from users
      - name: uuid
        description: Unique event identifier from Amplitude
        tests:
          - unique
          - not_null

  - name: int_companies
    description: Companies extracted from email domains, unique per (company, IP address)
    columns:
      - name: company_id
        description: Surrogate key from company name + IP address
        tests:
          - unique
          - not_null
      - name: company
        description: Company domain extracted from email (e.g., 'example.com')
        tests:
          - not_null
      - name: ip_address
        description: IP address associated with this company
        tests:
          - not_null