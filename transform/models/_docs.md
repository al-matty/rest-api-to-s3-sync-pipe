{% docs __overview__ %}
# Amplitude Analytics Silver Layer

This dbt project transforms raw Amplitude event data (JSON) into analytics-ready dimensional tables.

## Architecture
- **Staging Layer**: Parses JSON into typed columns (1:1 with source)
- **Intermediate Layer**: 6 dimensional/fact tables in the silver schema

## Key Features
- Surrogate keys generated using `dbt_utils.generate_surrogate_key()`
- Incremental models for events and sessions
- Comprehensive data quality testing
- Deduplication by UUID in events table

For more details, see the [project README](https://github.com/your-org/amplitude).
{% enddocs %}

<!-- Core Identifiers -->

{% docs amplitude_id %}
Amplitude's internal user identifier. This is the primary key for users and persists across sessions and devices.
{% enddocs %}

{% docs user_id %}
User identifier, typically an email address or custom user ID from your application.
{% enddocs %}

{% docs device_id %}
Unique identifier for the device used to generate the event.
{% enddocs %}

{% docs uuid %}
Unique event identifier generated by Amplitude. Used as the basis for event_id surrogate key.
{% enddocs %}

{% docs event_id_raw %}
Raw event ID from Amplitude (numeric). Not guaranteed to be unique.
{% enddocs %}

{% docs session_id_raw %}
Raw session ID from Amplitude (numeric). Multiple events share the same session ID.
{% enddocs %}

<!-- Surrogate Keys -->

{% docs surrogate_key_methodology %}
Surrogate keys in this project are generated using `dbt_utils.generate_surrogate_key()` which creates MD5 hashes of the input fields. This ensures consistent, deterministic keys across runs.
{% enddocs %}

{% docs event_id %}
Surrogate key generated from UUID. This is the primary key for the events table and is guaranteed to be unique after deduplication.
{% enddocs %}

{% docs session_id %}
Surrogate key generated from `session_id_raw || amplitude_id`. Uniquely identifies a user session.
{% enddocs %}

{% docs ip_address_id %}
Surrogate key generated from IP address. Links to the ip_addresses dimension table.
{% enddocs %}

{% docs event_properties_id %}
Surrogate key generated from the full event properties JSON object. Links to the event_properties dimension table.
{% enddocs %}

{% docs user_properties_id %}
Surrogate key generated from the full user properties JSON object. Captures the state of user properties at the time of the event.
{% enddocs %}

{% docs company_id %}
Surrogate key generated from `company || ip_address`. Uniquely identifies a company-IP combination.
{% enddocs %}

{% docs location_id %}
Surrogate key generated from `city || region || country`. Identifies geographic location of the event.
{% enddocs %}

<!-- Timestamps -->

{% docs event_time %}
Timestamp when the event occurred (in UTC). This is the primary timestamp used for incremental model filtering.
{% enddocs %}

{% docs client_event_time %}
Timestamp when the event was generated on the client device. May differ from event_time due to clock skew.
{% enddocs %}

{% docs server_received_time %}
Timestamp when Amplitude's servers received the event.
{% enddocs %}

{% docs last_seen %}
Timestamp of the most recent event for a given user. Updated with each new event.
{% enddocs %}

{% docs session_start %}
Timestamp of the first event in a session.
{% enddocs %}

{% docs session_end %}
Timestamp of the last event in a session.
{% enddocs %}

<!-- Event Data -->

{% docs event_type %}
Type of event (e.g., "page_view", "session_start", "button_click"). This is a required field from Amplitude.
{% enddocs %}

{% docs event_properties %}
JSON/VARIANT column containing all event-level properties (page URL, referrer, clicked element, etc.).
{% enddocs %}

{% docs user_properties %}
JSON/VARIANT column containing all user-level properties (plan type, account status, preferences, etc.).
{% enddocs %}

<!-- Geographic Data -->

{% docs ip_address %}
IP address from which the event originated. Used for geolocation and company identification.
{% enddocs %}

{% docs city %}
City name derived from IP geolocation.
{% enddocs %}

{% docs region %}
Region/state derived from IP geolocation.
{% enddocs %}

{% docs country %}
Country name derived from IP geolocation.
{% enddocs %}

<!-- Device & Platform -->

{% docs platform %}
Platform generating the event (Web, iOS, Android, etc.).
{% enddocs %}

{% docs os_name %}
Operating system name (e.g., "Mac OS X", "Windows", "iOS").
{% enddocs %}

{% docs os_version %}
Operating system version number.
{% enddocs %}

{% docs device_type %}
Device type category (e.g., "Mac", "Windows", "Mobile", "Tablet").
{% enddocs %}

{% docs device_family %}
Device family/model (e.g., "iPhone", "MacBook").
{% enddocs %}

<!-- Session Aggregates -->

{% docs event_count %}
Number of events in the session. Calculated by counting all events with the same session_id.
{% enddocs %}

{% docs user_journey %}
Concatenated page paths showing user navigation flow through the session. Pages are separated by " > " and ordered chronologically.
{% enddocs %}

<!-- Event Properties Fields -->

{% docs url %}
Page URL extracted from event properties `[Amplitude] Page URL`. Truncated to 1000 characters.
{% enddocs %}

{% docs referrer %}
Referrer URL showing where the user came from. Truncated to 1000 characters.
{% enddocs %}

{% docs referring_domain %}
Domain extracted from the referrer URL. Truncated to 255 characters.
{% enddocs %}

{% docs element_text %}
Text content of the clicked element (for click events). Truncated to 500 characters.
{% enddocs %}

{% docs page_title %}
Browser page title. Truncated to 500 characters.
{% enddocs %}

{% docs properties_json %}
Full event properties stored as VARIANT/JSON. This is the source for all extracted event property fields.
{% enddocs %}

<!-- Company Fields -->

{% docs company %}
Company domain extracted from email address (the part after @). Consumer email providers (gmail.com, yahoo.com, etc.) are filtered out.
{% enddocs %}

{% docs company_name %}
Denormalized company name stored in the events table for query performance. Populated from the users.company field.
{% enddocs %}

<!-- Data Quality Notes -->

{% docs deduplication_note %}
This model deduplicates events by UUID using a ROW_NUMBER() window function, keeping the most recent record by event_time. Duplicate UUIDs can occur due to data reprocessing or SDK retry logic.
{% enddocs %}

{% docs incremental_strategy %}
This model uses incremental materialization to improve performance. On incremental runs, it only processes events with `event_time > max(event_time)` from the existing table. Use `dbt run --full-refresh` to rebuild from scratch.
{% enddocs %}

<!-- Model-Level Documentation -->

{% docs int_events_model %}
## Deduplicated Event Fact Table

Core fact table containing all Amplitude events with deduplication and enrichment.

### Key Features
- **Deduplication**: Uses UUID with ROW_NUMBER() to remove duplicates (keeps most recent by event_time)
- **Incremental**: Only processes events with `event_time > max(event_time)` from existing table
- **Surrogate Keys**: Generates FK relationships to dimension tables (users, sessions, IP addresses, event properties)
- **Denormalization**: Includes `company_name` from users table for query performance

### Dependencies
- `stg_amplitude_events` (source data)
- `int_users` (for company enrichment)

### Refresh Strategy
Run incrementally on a regular schedule (hourly/daily). Use `--full-refresh` for historical backfills.
{% enddocs %}

{% docs int_users_model %}
## User Dimension Table

User dimension with latest device, IP address, and company information for each unique Amplitude user.

### Key Features
- **Grain**: One row per `amplitude_id`
- **Latest State**: Uses most recent event per user (by `event_time`)
- **Company Matching**: Prioritizes company matching user's email domain, falls back to first alphabetically
- **Foreign Keys**: Links to `int_ip_addresses` via `ip_address_id`

### Logic
1. Ranks events by `amplitude_id` and `event_time DESC`
2. Extracts company from email domain (`user_id`)
3. Matches with companies table, preferring email domain match
4. Captures latest `device_id`, `ip_address_id`, and `last_seen` timestamp

### Usage
Join to `int_events` on `amplitude_id` for user attributes and company information.
{% enddocs %}

{% docs int_sessions_model %}
## Session Aggregation Table

Sessionized events aggregated by Amplitude's session identifiers.

### Key Features
- **Incremental**: Only processes events with `event_time > max(session_end)` from existing table
- **Session Grain**: One row per unique `session_id` (hash of `session_id_raw || amplitude_id`)
- **User Journey**: LISTAGG of page paths showing navigation flow through session
- **Aggregations**: Session start/end times, event count, location

### Columns Generated
- `session_start`: First event timestamp in session
- `session_end`: Last event timestamp in session
- `event_count`: Total events in session
- `user_journey`: Concatenated page paths (ordered by event_time)
- `location_id`: Surrogate key for city/region/country combination

### Refresh Strategy
Run incrementally to capture new sessions. Use `--full-refresh` for recalculating historical sessions.
{% enddocs %}

{% docs int_ip_addresses_model %}
## IP Address Dimension Table

Simple dimension table of unique IP addresses with surrogate keys.

### Key Features
- **Grain**: One row per unique IP address
- **Purpose**: Provides consistent `ip_address_id` for FK relationships
- **Source**: Distinct IP addresses from all staging events

### Usage
- Referenced by `int_users` and `int_companies` for IP-based relationships
- Enables tracking user activity by IP address
- Supports geolocation analysis (IP â†’ city/region/country)
{% enddocs %}

{% docs int_event_properties_model %}
## Event Properties Dimension Table

Distinct combinations of event properties with commonly extracted fields.

### Key Features
- **Grain**: One row per unique event properties JSON object
- **Extracted Fields**: Commonly used properties parsed from JSON (URL, referrer, element text, page title)
- **Truncation**: Field lengths limited for database efficiency (URL: 1000 chars, referrer: 1000 chars, etc.)
- **Surrogate Key**: MD5 hash of full `event_properties` JSON

### Extracted Fields
- `url`: Page URL from `[Amplitude] Page URL`
- `referrer`: Referrer URL
- `referring_domain`: Domain extracted from referrer
- `element_text`: Clicked element text from `[Amplitude] Element Text`
- `page_title`: Browser page title from `[Amplitude] Page Title`
- `properties_json`: Full VARIANT/JSON for custom queries

### Usage
Join to `int_events` on `event_properties_id` to access parsed event properties without JSON parsing overhead.
{% enddocs %}

{% docs int_companies_model %}
## Company Dimension Table

Companies extracted from user email domains, filtered to exclude consumer email providers.

### Key Features
- **Extraction Logic**: Parses domain from `user_id` (email address) using `split_part(@, 2)`
- **Consumer Filtering**: Excludes gmail.com, yahoo.com, outlook.com, etc. (14 common providers)
- **IP Association**: Links companies to IP addresses (one company can have multiple IPs)
- **Surrogate Key**: MD5 hash of `company || ip_address`

### Business Logic
Identifies organizational users by filtering out consumer email providers. Useful for:
- B2B analytics (excluding personal email users)
- Company-level aggregations
- Account-based tracking

### Excluded Domains
Gmail, Yahoo, Hotmail, Outlook, AOL, iCloud, Mail.com, ProtonMail, Live, MSN, Ymail, GoogleMail, Me.com, Mac.com, Comcast, Verizon

### Usage
Join to `int_users` on `company` field to enrich user dimension with company information.
{% enddocs %}
